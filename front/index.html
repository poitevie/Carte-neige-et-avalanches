<!DOCTYPE html>
<style type="text/css">
  /* Définition du style pour l'élément avec l'identifiant 'viewerDiv' */
  #viewerDiv {
    width: 100%;
    /* Largeur à 100% */
    height: 600px;
    /* Hauteur à 600 pixels */
  }
</style>

<!-- Importation de la feuille de style pour Leaflet, une bibliothèque pour la cartographie -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />

<!-- Importation de la bibliothèque Leaflet -->
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>

<!-- Importation de la bibliothèque jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Définition d'un élément div pour la carte -->
<div id="viewerDiv"></div>

<script type="text/javascript">
  /* Lorsque la fenêtre est entièrement chargée */
  window.onload = function () {
    /* Initialisation de la carte avec Leaflet dans l'élément div avec id 'viewerDiv',
    avec une vue centrée sur les coordonnées [45.15384615384615, 5.6923076923076925]
    et un zoom de 10 */
    var map = L.map("viewerDiv").setView(
      [45.17384615384615, 5.71],
      10
    );

    /* Ajout de la couche de tuiles pour la carte via une URL de service de tuiles */
    var ign = L.tileLayer(
      "https://wxs.ign.fr/decouverte/geoportail/wmts?service=WMTS&request=GetTile&version=1.0.0&tilematrixset=PM&tilematrix={z}&tilecol={x}&tilerow={y}&layer=ORTHOIMAGERY.ORTHOPHOTOS&format=image/jpeg&style=normal",
      {
        minZoom: 0 /* Niveau de zoom minimum */,
        maxZoom: 18 /* Niveau de zoom maximum */,
        tileSize: 256 /* Taille des tuiles */,
        attribution:
          "IGN-F/Géoportail" /* Crédit à afficher pour les données */,
      }
    ).addTo(map);

    var osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap",
    });

    var baseMaps = {
      "OpenStreetMap": osm,
      "IGN découverte": ign,
    };

    var layerControl = L.control.layers(baseMaps).addTo(map);

    //Gestion des cartes déja affiché
    var carte = [];

    /* Création d'un élément canvas pour dessiner une image */
    var canvas = document.createElement("canvas");


    // Chargement des données JSON depuis l'url
    function getImage(numMassif) {
      var url = `http://localhost/skitour/back/getrisquemassif.php?massif=${numMassif}`;
      $.getJSON(url, function (data) {
        canvas.width = data["width"]; /* Largeur */
        canvas.height = data["height"]; /* Hauteur */
        var ctx = canvas.getContext("2d"); /* Récupération du contexte de dessin pour le canvas */
        var risque = data["tile"];
        var bg = data["bg"];
        var hd = data["hd"];
        // Boucle pour dessiner sur le canvas
        for (var i = 0; i < canvas.height; i++) {
          for (var j = 0; j < canvas.width; j++) {
            var alt = risque[i][j];
            switch (alt) {
              case 0:
                continue;
              case 1:
                ctx.fillStyle = "rgb(44, 176, 81)";
                break
              case 2:
                ctx.fillStyle = "rgb(254, 240, 53)";
                break
              case 3:
                ctx.fillStyle = "rgb(253, 127, 54)";
                break
              case 4:
                ctx.fillStyle = "rgb(236, 11, 24)";
                break
              case 5:
                ctx.fillStyle = "rgb(131, 7, 12)";
                break
              default:
                break;
            }

            ctx.globalAlpha = 0.5;
            ctx.fillRect(j, i, 1, 1);
          }
        }

        // Ajout de l'image créée sur le canvas en tant qu'overlay sur la carte
        var imageOverlay = L.imageOverlay(
          canvas.toDataURL(),
          L.latLngBounds([bg, hd]),
          {
            opacity: 1,
          }
        ).addTo(map);
      });
    }

    //Recupere les rectangles autour des massifs depuis un fichier .JSOn
    let massif;
    $.getJSON("cadremassif.json", function (data) {

      var test = new Map(data.map((e) => [e.id, e.cadre]));
      massif = new Map(data.map((e) => [e.id, e.cadre]));
    }).then((o) => {

      //Affichage des images concernés lors de la premiere génèration de l'image
      var grille = MassifAfficher();
      grille.forEach(e => getImage(e));
    })


    //Permet de savoir si un point est dans un rectangle ou non
    function dansRect(P, bg, bd, hg, hd) {

      return bg[0] <= P[0] && hg[0] >= P[0] && P[1] >= bg[1] && P[1] <= bd[1]
    }

    //Verifie si un rectangle entourant un massif est afficher a l'écran
    function dansMassif(value, key, ma) {

      var SWma = value.bg;
      var NEma = value.hd;
      var NWma = value.hg;
      var SEma = value.bd;

      var NE = [map.getBounds().getNorthEast().lat, map.getBounds().getNorthEast().lng];
      var NW = [map.getBounds().getNorthWest().lat, map.getBounds().getNorthWest().lng];
      var SE = [map.getBounds().getSouthEast().lat, map.getBounds().getSouthEast().lng];
      var SW = [map.getBounds().getSouthWest().lat, map.getBounds().getSouthWest().lng];
      if (dansRect(SWma, SW, SE, NW, NE)&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(NEma, SW, SE, NW, NE) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(NWma, SW, SE, NW, NE) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(SEma, SW, SE, NW, NE) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key);
        carte.push(key);
      }
      if (dansRect(SW, SWma, SEma, NWma, NEma) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(NE, SWma, SEma, NWma, NEma) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(NW, SWma, SEma, NWma, NEma) && !(ma.includes(key))&& !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
      if (dansRect(SE, SWma, SEma, NWma, NEma) && !(ma.includes(key)) && !(carte.includes(key))) {
        ma.push(key)
        carte.push(key);
      }
    }


    //Determiner tout les massifs à afficher
    function MassifAfficher() {
      var ma = [];

      var key = massif.entries();
      var x = key.next().value;

      while (x != undefined) {
        dansMassif(x[1], x[0], ma);
        var x = key.next().value;
      }
      return ma;
    }



    //Gestion des events de Drag
    map.on('dragend', function (e) {
      if (map.getZoom() >= 10) {
        var grille = MassifAfficher();
        grille.forEach(e => getImage(e))
      }
    });

    //Event qui affiche la carte a la fin d'un zoom/dezoom
    map.on('zoomend', function (e) {
      if (map.getZoom() >= 10) {
        var grille = MassifAfficher();
        grille.forEach(e => getImage(e))
      }
    });
  }
</script>